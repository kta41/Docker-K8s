
resources:
  - ../../base
  - cert.yaml
  - ingress.yaml

# Definimos el valor aquí una sola vez
configMapGenerator:
  - name: litellm-config
    literals:
      - subdomain=litellm
      - full_domain=litellm.kta41.local

# Esta es la "magia" que busca los placeholders y los pisa
replacements:
  - source:
      kind: ConfigMap
      name: litellm-config
      fieldPath: data.full_domain
    targets:
      - select:
          kind: Ingress
          name: litellm-ingress
        fieldPaths:
          - spec.rules.0.host
          - spec.tls.0.hosts.0
      - select:
          kind: Certificate
          name: litellm-tls
        fieldPaths:
          - spec.dnsNames.0
      - select:
          kind: Deployment
          name: litellm-deployment
        fieldPaths:
          - spec.template.spec.containers.0.env.[name=LITELLM_PROXY_BASE_URL].value
        options:
          delimiter: "/"
          index: 2 # Esto apunta a la parte del host en la URL https://host/

# ------------------------------------------------------------------------------

# Si quieres que los env vars del deployment usen el sub‑dominio, también
# puedes aplicar un “patch” aquí (pero ya lo incluí en deployment.yaml con
# la sintaxis {{ .Subdomain }}; Kustomize lo sustituirá automáticamente).
